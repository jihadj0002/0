{% extends 'back/base.html' %}
{% block title %}Dashboard | Matrix AI{% endblock %}

{% block extra_css %}


<style>
  /* Extra analytics styling */
  .panel.analytics-panel {
    background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.05);
    padding:20px; transition:transform 0.2s ease;
  }
  .panel.analytics-panel:hover {transform:translateY(-4px)}
  .panel-header{display:flex;justify-content:space-between;align-items:center}
  .panel-sub{color:#888;font-size:0.85rem}
  .chart-wrap{margin:12px 0}
  .sparkline{width:100%;height:80px}
  .sales-stats{display:flex;justify-content:space-between;flex-wrap:wrap;gap:12px}
  .s-label{font-size:0.9rem;color:#666}
  .s-value{font-size:1.2rem;font-weight:600;color:#111}
  .time-range{display:flex;gap:6px}
  .time-btn{border:none;background:#f3f4f6;color:#555;font-size:0.8rem;font-weight:500;
    padding:4px 8px;border-radius:6px;cursor:pointer;transition:all 0.2s ease;}
  .time-btn:hover{background:#e5e7eb}
  .time-btn.active{background:#2563eb;color:#fff}
  .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-top:18px}
  .card{background:#fff;padding:18px;border-radius:12px;box-shadow:var(--shadow)}
  .card-title{color:var(--muted);font-weight:600}
  .card-value{font-size:22px;font-weight:800;margin-top:6px}
</style>


{% endblock %}

{% block content %}
<div class="page-header">
  <h1>Welcome, your e-commerce store</h1>
  <p class="sub">Overview of chatbot activity, sales and product performance.</p>
</div>

<div class="cards">
  <div class="card"><div class="card-title">Sales</div><div class="card-value">${{ total_sales|floatformat:2 }}</div></div>
  <div class="card"><div class="card-title">Total Conversations</div><div class="card-value">{{ total_conversations }}</div></div>
  <div class="card"><div class="card-title">Conversion Rate</div><div class="card-value">{{ conversion_rate }}</div></div>
  <div class="card"><div class="card-title">Active Products</div><div class="card-value">{{ active_products }}</div></div>
</div>

<!-- Analytics Section -->
<div class="layout-3cols" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-top:20px">
  <!-- Order Analytics -->
  <div class="panel analytics-panel">
    <div class="panel-header">
      <div>
        <h2>Order Analytics</h2>
        <div class="panel-sub" id="analytics-range-label">Last 30 Days</div>
      </div>
      <div class="time-range">
        <button class="time-btn active" data-range="1D">1D</button>
        <button class="time-btn" data-range="7D">7D</button>
        <button class="time-btn" data-range="30D">30D</button>
        <button class="time-btn" data-range="6M">6M</button>
      </div>
    </div>

    <div class="chart-wrap">
      <svg viewBox="0 0 300 120" class="sparkline" preserveAspectRatio="none" id="analytics-chart">
        <polyline fill="none" stroke="#22c55e" stroke-width="3" id="order-chart-line"
          points="0,90 30,80 60,70 90,50 120,55 150,45 180,30 210,35 240,25 270,20 300,15"/>
      </svg>
    </div>

    <div class="sales-stats">
      <div><div class="s-label">Total Orders</div><div class="s-value" id="total-orders">{{ total_orders }}</div></div>
      <div><div class="s-label">Completed</div><div class="s-value" id="completed-orders">{{ completed }}</div></div>
      <div><div class="s-label">Pending</div><div class="s-value" id="pending-orders">{{ pending }}</div></div>
    </div>
  </div>

  <!-- Message Analytics -->
  <div class="panel analytics-panel">
    <div class="panel-header">
      <div><h2>Message Status Analytics</h2><div class="panel-sub" id="msg-range-label">Overview</div></div>
      <div class="time-range">
  <button class="time-btn active" data-range="1D">1D</button>
  <button class="time-btn" data-range="7D">7D</button>
  <button class="time-btn" data-range="30D">30D</button>
  <button class="time-btn" data-range="6M">6M</button>
</div>

    </div>
    <div class="chart-wrap">
      <svg viewBox="0 0 300 120" class="sparkline" preserveAspectRatio="none">
        <polyline fill="none" stroke="#f97316" stroke-width="3" id="msg-chart-line"
          points="0,100 30,90 60,70 90,80 120,50 150,40 180,60 210,30 240,35 270,20 300,25"/>
      </svg>
    </div>
    <div class="sales-stats">
      <div><div class="s-label">Total Conversations</div><div class="s-value" id="total-conversations">{{ total_conversations }}</div></div>
      <div><div class="s-label">Total Sent Messages</div><div class="s-value" id="replied-messages">{{ replied_messages }}</div></div>
      <div><div class="s-label">Average</div><div class="s-value" id="average-messages">{{ average_messages }}</div></div>
    </div>
  </div>

  <!-- Sales & Revenue -->
  <div class="panel analytics-panel">
    <div class="panel-header">
      <div><h2>Sales & Revenue</h2><div class="panel-sub" id="sales-range-label">Last 30 Days</div></div>
      <div class="time-range">
        <button class="time-btn active">1D</button><button class="time-btn">7D</button>
        <button class="time-btn">30D</button><button class="time-btn">6M</button>
      </div>
    </div>
    <div class="chart-wrap">
      <svg viewBox="0 0 300 120" class="sparkline" preserveAspectRatio="none">
        <polyline fill="none" stroke="#2563eb" stroke-width="3" id="sales-chart-line"
          points="0,90 30,70 60,85 90,60 120,80 150,55 180,65 210,40 240,60 270,30 300,20"/>
      </svg>
    </div>
    <div class="sales-stats">
      <div><div class="s-label">Avg Order</div><div class="s-value" id="avg-orders">${{total_sales}}</div></div>
      <div><div class="s-label">Chat Sales</div><div class="s-value" id="chat-sales">{{orders_count}}</div></div>
      <div><div class="s-label">Response Time</div><div class="s-value" id="response-time">1 Min</div></div>
    </div>
  </div>
</div>

<!-- Lower Panels -->
<div class="layout-3cols" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:18px;margin-top:20px">
  <div class="small-panel">
    <h3>Top Products (via Chatbot)</h3>
    <ol class="product-list">
  {% for product in top_products %}
    <li>
      {{ product.name }}
      <span class="muted">— {{ product.sold }} .</span>
    </li>
  {% empty %}
    <li>No active products yet.</li>
  {% endfor %}
</ol>
  </div>

  <div class="small-panel">
    <h3>Integrations</h3>
    <ul class="integrations-list">
      <li>Facebook Messenger <span class="dot connected">connected</span></li>
      <li>Shopify <span class="dot sync">sync</span></li>
      <li>WhatsApp <span class="dot off">not connected</span></li>
    </ul>
  </div>

  <div class="small-panel">
    <h3>Automation Quick Toggle</h3>
    <div class="toggle-row">
      <label class="switch"><input type="checkbox" checked><span class="slider"></span></label>
      <div class="toggle-label">Auto-respond to FAQs</div>
    </div>
    <div class="toggle-row">
      <label class="switch"><input type="checkbox"><span class="slider"></span></label>
      <div class="toggle-label">Upsell recommended products</div>
    </div>
  </div>
</div>


{% comment %} Order Analytics {% endcomment %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const buttons = document.querySelectorAll(".time-btn");

  const totalEl = document.getElementById("total-orders");
  const completedEl = document.getElementById("completed-orders");
  const pendingEl = document.getElementById("pending-orders");
  const chartLine = document.getElementById("order-chart-line");
  const rangeLabel = document.getElementById("analytics-range-label");
  
  const avgOrd = document.getElementById("avg-orders");
  const cSells = document.getElementById("chat-sales");
  const responseTime = document.getElementById("response-time");
  const salesChartLine = document.getElementById("sales-chart-line");
  const salesRangeLabel = document.getElementById("sales-range-label");


  // Default load (30D)
  loadOrderAnalytics("30D");

  buttons.forEach(btn => {
    btn.addEventListener("click", () => {
      buttons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      const range = btn.dataset.range;
      const labels = {
        "1D": "Last 24 Hours",
        "7D": "Last 7 Days",
        "30D": "Last 30 Days",
        "6M": "Last 6 Months"
      };
      rangeLabel.textContent = labels[range] || "Last 30 Days";

      loadOrderAnalytics(range);
    });
  });

  function loadOrderAnalytics(range) {
    // show loading placeholder
    totalEl.textContent = "...";
    completedEl.textContent = "...";
    pendingEl.textContent = "...";

    fetch(`{% url 'back:order_analytics' %}?range=${range}`)
      .then(res => {
        if (!res.ok) throw new Error("Network response was not ok");
        return res.json();
      })
      .then(data => {
        totalEl.textContent = data.total_orders ?? 0;
        completedEl.textContent = data.completed ?? 0;
        pendingEl.textContent = data.pending ?? 0;

        // Update sparkline
        const max = Math.max(...data.chart_data, 1);
        const scaleY = 100 / max;
        const points = data.chart_data
          .map((v, i) => `${i * 25},${100 - v * scaleY}`)
          .join(" ");
        chartLine.setAttribute("points", points);
      })
      .catch(err => {
        console.error("Error fetching analytics:", err);
        totalEl.textContent = "–";
        completedEl.textContent = "–";
        pendingEl.textContent = "–";
      });
  }
});
</script>
{% comment %} Chat Analytics {% endcomment %}
{% comment %} Chat Analytics {% endcomment %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const buttons = document.querySelectorAll(".time-btn");

  const totalEl = document.getElementById("total-conversations");
  const repliedEl = document.getElementById("replied-messages");
  const avgEl = document.getElementById("average-messages");
  const chartLine = document.getElementById("msg-chart-line");
  const rangeLabel = document.getElementById("msg-range-label");

  const labels = {
    "1D": "Last 24 Hours",
    "7D": "Last 7 Days",
    "30D": "Last 30 Days",
    "6M": "Last 6 Months"
  };

  loadChatAnalytics("30D");

  buttons.forEach(btn => {
    btn.addEventListener("click", () => {
      buttons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      const range = btn.dataset.range;
      rangeLabel.textContent = labels[range] || "Overview";
      loadChatAnalytics(range);
    });
  });

  function loadChatAnalytics(range) {
    totalEl.textContent = "...";
    repliedEl.textContent = "...";
    avgEl.textContent = "...";

    fetch(`{% url 'back:chat_metrics' %}?range=${range}`)
      .then(res => {
        if (!res.ok) throw new Error("Request failed");
        return res.json();
      })
      .then(data => {
        totalEl.textContent = data.total_conversations;
        repliedEl.textContent = data.replied_messages;
        avgEl.textContent = data.average_messages;

        updateSparkline(data.chart_data || []);
      })
      .catch(err => {
        console.error(err);
        totalEl.textContent = "–";
        repliedEl.textContent = "–";
        avgEl.textContent = "–";
      });
  }

  function updateSparkline(values) {
    if (!values.length) {
      chartLine.setAttribute("points", "0,100 300,100");
      return;
    }

    const max = Math.max(...values, 1);
    const width = 300;
    const height = 100;
    const step = width / (values.length - 1);

    const points = values
      .map((v, i) => {
        const x = i * step;
        const y = height - (v / max) * height;
        return `${x},${y}`;
      })
      .join(" ");

    chartLine.setAttribute("points", points);
  }
});
</script>



{% comment %} End Msg analytics {% endcomment %}

<script>

  // Sales & Revenue Analytics
document.addEventListener("DOMContentLoaded", () => {
  const salesButtons = document.querySelectorAll(".time-btn");
  const salesChartLine = document.getElementById("sales-chart-line");
  const salesRangeLabel = document.getElementById("sales-range-label");

  const avgOrdersEl = document.getElementById("avg-orders");
  const chatSalesEl = document.getElementById("chat-sales");
  const responseTimeEl = document.getElementById("response-time");

  // Default load (30D)
  loadSalesAnalytics("30D");

  // Handle time range clicks
  salesButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      salesButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      const range = btn.textContent.trim(); // "1D", "7D", etc.
      const labels = {
        "1D": "Last 24 Hours",
        "7D": "Last 7 Days",
        "30D": "Last 30 Days",
        "6M": "Last 6 Months"
      };
      salesRangeLabel.textContent = labels[range] || "Last 30 Days";

      loadSalesAnalytics(range);
    });
  });

  function loadSalesAnalytics(range) {
    // Set placeholders while loading
    avgOrdersEl.textContent = "...";
    chatSalesEl.textContent = "...";
    responseTimeEl.textContent = "...";

    fetch(`{% url 'back:sales_analytics' %}?range=${range}`)
      .then(res => {
        if (!res.ok) throw new Error("Network response was not ok");
        return res.json();
      })
      .then(data => {
        // Update values from backend data
        const totalOrders = data.total_orders ?? 0;
        const completed = data.completed ?? 0;
        const pending = data.pending ?? 0;

        // Example placeholders — customize as needed
        avgOrdersEl.textContent = `$${totalOrders * 10}`; // fake avg revenue
        chatSalesEl.textContent = completed;              // completed orders
        responseTimeEl.textContent = pending + " mins";   // fake metric

        // Update sparkline dynamically
        const max = Math.max(...data.chart_data, 1);
        const scaleY = 100 / max;
        const points = data.chart_data
          .map((v, i) => `${i * 25},${100 - v * scaleY}`)
          .join(" ");
        salesChartLine.setAttribute("points", points);
      })
      .catch(err => {
        console.error("Error fetching sales analytics:", err);
        avgOrdersEl.textContent = "–";
        chatSalesEl.textContent = "–";
        responseTimeEl.textContent = "–";
      });
  }
});
</script>




{% endblock %}
